## conga-facts

This role supplies the configuration from the CONGA model as facts. It consists mainly of an action plugin which can be used independently from the role, but is packaged as a role so that other roles can declare it as dependency and have access to the CONGA facts.

To determine which CONGA role to use in a specific context, the plugin uses different strategies. Generally speaking, it tries to match the name of an Ansible role to the name of a CONGA role, so that it should be enough to name an Ansible role identical to a CONGA role to automatically match it. A `conga-` prefix is stripped from the Ansible role name before the comparison, so that you can quickly identify the CONGA specific roles from their name. Specifically, the lookup logic works like this:

* It checks whether the `conga_role_mapping` variable is set and use that role name if it is. This can be used to explicitly set a role if the auto resolution fails or a generic Ansible role should be mapped to specific CONGA role.
* It checks whether the name of the current Ansible role matches a CONGA role name. This works if `conga_facts` is executed as a task in the context of a properly named role.
* It checks whether the name of the first Ansible role in the dependency chain matches a CONGA role name. This works if `conga_facts` is executed as a (transitive) dependency of a properly named role.
* It checks whether the role of the parent of the current task matches a CONGA role name. This works if `conga_facts` is executed via the `include_role` task, either directly or indirectly.

## Requirements

This role needs access to the CONGA `model.yml` files generated by CONGA. It tries to read the model files from the directory specified by the `conga_basedir` variable for the `conga` host. For this to work, the `conga` role needs to have be executed on the `conga` host before this role is executed or the `conga_basedir` variable needs to be set explicitly. Please note that the `conga` host currently always has to be localhost since action plugins always run locally (and only an action plugin are allowed enough insight into the playbook structure for the plugin to to its magic).

The role also needs to know the current CONGA environment and the CONGA node the current host represents. This is achieved by setting the `conga_environment` and `conga_node` variables. `conga_node` can be set in the inventory for a host, but only if there's a 1:1 host:node mapping. If more than one CONGA node is represented by a single Ansible host this won't work and the node mapping needs to be explicitly set in the playbook. The `conga_environment` variable can be set as a group variable for an inventory group that represents the environment.

## Role Variables

| Name              | Description          |
|-------------------|----------------------|
| `conga_environment` | Name of the CONGA environment to use. |
| `conga_node` | Name of the CONGA node to use for the current host. See above. |
| `conga_basedir` | Base directory of the CONGA configuration. See above.  |
| `conga_model_file` | Name of the CONGA model file. Defaults to `model.yaml`. |

## Facts

The following facts are supplied by the `conga_facts` role/plugin:

* `{{ conga_role }}`: Name of the current CONGA role
* `{{ conga_variant }}`: Name of the current CONGA variant
* `{{ conga_config }}`: The CONGA config parameters resolved for the current CONGA role/variant combination
* `{{ conga_config_path }}`: The base path of the files generated by CONGA for the current node.
* `{{ conga_tenants }}`: The CONGA tenants and their resolved config
* `{{ conga_files }}`: The list of config files generated by CONGA for the role/variant. The paths are relative to `conga_config_path`
* `{{ conga_packages }}`: The list of AEM packages generated by CONGA for the role/variant. The paths are relative to `conga_config_path`
* `{{ conga_directories }}`: A list of unique config directories generated by CONGA

